"""
FSMstates.py
============
Определение состояний конечного автомата (FSM) для многошаговых сценариев
Используется библиотека aiogram для управления диалогами с пользователем
"""

from aiogram.fsm.state import State, StatesGroup


# ============================================================================
# СОСТОЯНИЯ РЕГИСТРАЦИИ
# ============================================================================

class RegistrationStates(StatesGroup):
    """
    Состояния процесса регистрации нового пользователя
    Последовательность: пароль → подтверждение → имя → фамилия → email
    """
    waiting_for_password = State()          # Ожидание ввода пароля
    waiting_for_confirm_password = State()  # Ожидание подтверждения пароля
    waiting_for_first_name = State()        # Ожидание ввода имени
    waiting_for_last_name = State()         # Ожидание ввода фамилии
    waiting_for_email = State()             # Ожидание ввода email


# ============================================================================
# СОСТОЯНИЯ ВХОДА В СИСТЕМУ
# ============================================================================

class LoginStates(StatesGroup):
    """
    Состояния процесса входа в систему
    """
    waiting_for_password = State()  # Ожидание ввода пароля после выбора роли


# ============================================================================
# СОСТОЯНИЯ СБРОСА ПАРОЛЯ
# ============================================================================

class PasswordResetStates(StatesGroup):
    """
    Состояния процесса сброса пароля через email
    Последовательность: email → код подтверждения → новый пароль → подтверждение
    """
    waiting_for_email = State()                   # Ожидание ввода email
    waiting_for_code = State()                    # Ожидание ввода кода из email
    waiting_for_new_password = State()            # Ожидание нового пароля
    waiting_for_confirm_new_password = State()    # Ожидание подтверждения нового пароля


# ============================================================================
# СОСТОЯНИЯ АВТОРИЗАЦИИ
# ============================================================================

class AuthStates(StatesGroup):
    """
    Состояния авторизованного пользователя
    """
    authorized = State()  # Пользователь успешно вошёл в систему


# ============================================================================
# СОСТОЯНИЯ ЧАТА КЛИЕНТА
# ============================================================================

class ClientChatStates(StatesGroup):
    """
    Состояния клиента во время чата с мастером
    """
    waiting_for_provider_id = State()  # Ожидание ввода ID мастера
    in_chat = State()                  # Активный чат с мастером


# ============================================================================
# СОСТОЯНИЯ ЧАТА МАСТЕРА
# ============================================================================

class ProviderChatStates(StatesGroup):
    """
    Состояния мастера во время чата с клиентом
    """
    in_chat = State()  # Активный чат с клиентом


# ============================================================================
# СОСТОЯНИЯ СОЗДАНИЯ ЗАПИСИ НА УСЛУГУ
# ============================================================================

class ServiceRecordStates(StatesGroup):
    """
    Состояния создания новой записи на услугу
    Последовательность: 
        клиент (если не из чата) → название → стоимость → адрес → 
        дата → время → комментарии
    """
    waiting_for_client_id = State()       # Ожидание ID клиента (если не из чата)
    waiting_for_service_name = State()    # Ожидание названия услуги
    waiting_for_cost = State()            # Ожидание стоимости
    waiting_for_address = State()         # Ожидание адреса
    waiting_for_date = State()            # Ожидание даты
    waiting_for_time = State()            # Ожидание времени
    waiting_for_comments = State()        # Ожидание комментариев


# ============================================================================
# СОСТОЯНИЯ КАЛЕНДАРЯ
# ============================================================================

class CalendarStates(StatesGroup):
    """
    Состояния навигации по календарю записей
    Последовательность: год → месяц → день
    """
    waiting_for_year = State()    # Выбор года
    waiting_for_month = State()   # Выбор месяца
    waiting_for_day = State()     # Выбор дня


# ============================================================================
# СОСТОЯНИЯ ЗАВЕРШЕНИЯ УСЛУГИ
# ============================================================================

class CompletionStates(StatesGroup):
    """
    Состояния завершения услуги после её выполнения
    Последовательность: выбор записи → длительность → оценка → комментарии
    """
    waiting_for_record_id = State()   # Выбор записи для завершения
    waiting_for_duration = State()    # Ввод длительности в минутах
    waiting_for_rating = State()      # Оценка качества (да/нет)
    waiting_for_notes = State()       # Добавление комментариев


# ============================================================================
# СОСТОЯНИЯ ОТМЕНЫ ЗАПИСИ
# ============================================================================

class CancellationStates(StatesGroup):
    """
    Состояния отмены активной записи
    """
    waiting_for_record_id = State()  # Выбор записи для отмены


# ============================================================================
# СОСТОЯНИЯ УЧЁТА ТРАТ
# ============================================================================

class ExpenseStates(StatesGroup):
    """
    Состояния добавления новой траты
    Последовательность: сумма → описание
    """
    waiting_for_amount = State()          # Ввод суммы траты
    waiting_for_description = State()     # Ввод описания траты


# ============================================================================
# СОСТОЯНИЯ СТАТИСТИКИ
# ============================================================================

class StatisticsStates(StatesGroup):
    """
    Состояния просмотра статистики
    """
    waiting_for_period = State()  # Выбор периода (день/неделя/месяц)


# ============================================================================
# СОСТОЯНИЯ ДОБАВЛЕНИЯ ФОТОГРАФИЙ К УСЛУГЕ
# ============================================================================

class PhotoStates(StatesGroup):
    """
    Состояния добавления фотографий к завершённой услуге
    
    Последовательность:
        1. Ожидание выбора "Да/Нет" для добавления фото
        2. Ожидание отправки фотографий и подписей
    """
    waiting_for_photos = State()   # Ожидание выбора "Да/Нет" для добавления фото
    waiting_for_caption = State()  # Ожидание отправки фотографий


# ============================================================================
# СОСТОЯНИЯ ЗАПРОСОВ ПОВТОРНОЙ ЗАПИСИ
# ============================================================================

class RepeatRequestStates(StatesGroup):
    """
    Состояния системы запросов повторной записи
    
    Последовательность для клиента:
        1. Просмотр списка мастеров → выбор или поиск
        2. Выбор типа поиска (по услуге / по имени)
        3. Ввод поискового запроса
        4. Выбор мастера из результатов поиска
        5. Написание сообщения мастеру
        6. Диалог запрос-ответ (чтение ответов, отправка новых сообщений)
    """
    # Этап 1: Выбор мастера из истории
    choosing_provider = State()      # Выбор мастера из списка истории
    
    # Этап 2: Поиск мастеров
    choosing_search_type = State()   # Выбор типа поиска (услуга/имя)
    entering_search_query = State()  # Ввод поискового запроса
    choosing_from_search = State()   # Выбор мастера из результатов поиска
    
    # Этап 3: Написание сообщения
    writing_message = State()        # Написание первого сообщения мастеру
    
    # Этап 4: Диалог запрос-ответ
    viewing_requests = State()       # Просмотр списка запросов (мастер)
    chatting = State()               # Активный диалог с клиентом


# ============================================================================
# СОСТОЯНИЯ ПОИСКА БЛИЖАЙШИХ МАСТЕРОВ
# ============================================================================

class NearbySearchStates(StatesGroup):
    """
    Состояния поиска ближайших мастеров
    
    Последовательность:
        1. Ввод адреса клиента
        2. Ввод названия услуги
        3. Отображение результатов поиска
    """
    waiting_for_address = State()    # Ожидание адреса клиента
    waiting_for_service = State()    # Ожидание названия услуги


# ============================================================================
# СОСТОЯНИЯ УПРАВЛЕНИЯ АДРЕСАМИ МАСТЕРА
# ============================================================================

class AddressManagementStates(StatesGroup):
    """
    Состояния управления адресами работы мастера
    
    Последовательность:
        1. Ввод нового адреса
        2. Геокодирование и сохранение
    """
    waiting_for_address = State()    # Ожидание нового адреса


# ============================================================================
# СОСТОЯНИЯ УПРАВЛЕНИЯ УСЛУГАМИ МАСТЕРА
# ============================================================================

class ServiceManagementStates(StatesGroup):
    """
    Состояния управления услугами мастера
    
    Последовательность:
        1. Ввод названия услуги
        2. Ввод описания
        3. Ввод диапазона цен
    """
    waiting_for_service_name = State()  # Ожидание названия услуги
    waiting_for_description = State()   # Ожидание описания
    waiting_for_price = State()         # Ожидание диапазона цен


# ============================================================================
# СОСТОЯНИЯ ОЦЕНКИ МАСТЕРА (ОТЗЫВОВ)
# ============================================================================

class ReviewStates(StatesGroup):
    """
    Состояния оценки мастера после завершения услуги
    
    Последовательность:
        1. Выбор оценки (1-5 звёзд)
        2. Ввод комментария
    """
    waiting_for_rating = State()    # Выбор оценки (1-5 звёзд)
    waiting_for_comment = State()   # Ввод комментария


# ============================================================================
# СОСТОЯНИЯ УПРАВЛЕНИЯ ФОТО ПРОФИЛЯ
# ============================================================================

class ProfilePhotoStates(StatesGroup):
    """
    Состояния загрузки фото профиля мастера
    
    Последовательность:
        1. Ожидание фотографии от пользователя
    """
    waiting_for_photo = State()     # Ожидание фотографии

# Добавьте в конец файла FSMstates.py:

class ProfileViewStates(StatesGroup):
    """Состояния просмотра профиля мастера"""
    choosing_search_method = State()  # Выбор способа поиска (по ID / из истории)
    entering_provider_id = State()    # Ввод ID мастера
    choosing_from_history = State()   # Выбор мастера из истории записей
    viewing_profile = State()         # Просмотр профиля и отзывов

class ReviewStates(StatesGroup):
    """Состояния оценки мастера после завершения услуги"""
    waiting_for_rating = State()    # Выбор оценки (1-5 звёзд)
    waiting_for_comment = State()   # Ввод комментария
