"""
handlers/statistics.py
======================
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ—Ö–æ–¥—ã, —Ä–∞—Å—Ö–æ–¥—ã, –Ω–∞–ª–æ–≥–∏ –∏ —á–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
"""

from aiogram import Router, F
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
import logging
from FSMstates import StatisticsStates
from database import get_statistics, get_tax_rate  # ‚Üê –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç!
from keyboards import statistics_period_keyboard, cancel_menu_keyboard
from handlers.logout import return_to_role_menu

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –°–æ–∑–¥–∞—ë–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
router = Router()


@router.message(F.text == "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
async def start_statistics(message: Message, state: FSMContext):
    """
    –ù–∞—á–∞–ª–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ (–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—è/–º–µ—Å—è—Ü)
    
    Args:
        message (Message): –í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        state (FSMContext): –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
    """
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞
    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", 
        reply_markup=statistics_period_keyboard()
    )
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞
    await state.set_state(StatisticsStates.waiting_for_period)


@router.message(StatisticsStates.waiting_for_period)
async def show_statistics(message: Message, state: FSMContext):
    """
    –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
    
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–æ—Ö–æ–¥—ã, —Ä–∞—Å—Ö–æ–¥—ã, –Ω–∞–ª–æ–≥–∏ –∏ —á–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥
    
    Args:
        message (Message): –°–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º –ø–µ—Ä–∏–æ–¥–∞
        state (FSMContext): –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
    """
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–º–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–∂–∞—Ç–∏–µ "–í –º–µ–Ω—é")
    if message.text == "–í –º–µ–Ω—é":
        await state.clear()
        await return_to_role_menu(message, state, role="provider")
        return
    
    # –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å –∫–æ–¥–æ–º –ø–µ—Ä–∏–æ–¥–∞
    period_map = {
        "üìä –ó–∞ –¥–µ–Ω—å": "day",
        "üìÖ –ó–∞ –Ω–µ–¥–µ–ª—é": "week",
        "üìÜ –ó–∞ –º–µ—Å—è—Ü": "month"
    }
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –ø–µ—Ä–∏–æ–¥–∞
    period = period_map.get(message.text)
    if not period:
        # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä - –ø—Ä–æ—Å–∏–º –≤—ã–±—Ä–∞—Ç—å —Å–Ω–æ–≤–∞
        await message.answer(
            "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏–∑ –º–µ–Ω—é:", 
            reply_markup=statistics_period_keyboard()
        )
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –Ω–∞–ª–æ–≥–æ–≤—É—é —Å—Ç–∞–≤–∫—É –∏–∑ –ë–î (–∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç 4%)
    tax_rate = await get_tax_rate('npd_individual') or 4.0
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
    stats = await get_statistics(
        provider_id=message.from_user.id,
        period=period,
        tax_rate=tax_rate
    )
    
    # ============================================================================
    # –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –û–¢–ß–Å–¢–ê
    # ============================================================================
    
    # –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–¥ –ø–µ—Ä–∏–æ–¥–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    period_names = {
        "day": "–¥–µ–Ω—å",
        "week": "–Ω–µ–¥–µ–ª—é",
        "month": "–º–µ—Å—è—Ü"
    }
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á—ë—Ç–∞
    report = f"üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ {period_names[period]}:\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ—Ö–æ–¥
    report += f"üí∞ –î–æ—Ö–æ–¥: {stats['income']} —Ä—É–±.\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—Ö–æ–¥—ã
    report += f"üí∏ –†–∞—Å—Ö–æ–¥—ã: {stats['expenses']} —Ä—É–±.\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–ª–æ–≥ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ç–∞–≤–∫–∏
    report += f"üßæ –ù–∞–ª–æ–≥ ({tax_rate}%): {stats['tax']} —Ä—É–±.\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —á–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥
    report += f"‚úÖ –ß–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥: {stats['net']} —Ä—É–±.\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
    report += (
        f"‚ÑπÔ∏è –°—Ç–∞–≤–∫–∞ –Ω–∞–ª–æ–≥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞ "
        f"{stats['tax_updated'].strftime('%d.%m.%Y')}\n\n"
    )
    
    # ============================================================================
    # –î–û–ë–ê–í–õ–Ø–ï–ú –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –§–ò–ù–ê–ù–°–û–í–û–ì–û –†–ï–ó–£–õ–¨–¢–ê–¢–ê
    # ============================================================================
    
    if stats['net'] < 0:
        # –†–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –¥–æ—Ö–æ–¥
        report += (
            "‚ö†Ô∏è –†–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –¥–æ—Ö–æ–¥. "
            "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã."
        )
    elif stats['net'] < stats['income'] * 0.3:
        # –ß–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥ –º–µ–Ω—å—à–µ 30% –æ—Ç –≤–∞–ª–æ–≤–æ–≥–æ
        report += (
            "üí° –ß–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥ –º–µ–Ω—å—à–µ 30% –æ—Ç –≤–∞–ª–æ–≤–æ–≥–æ. "
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã."
        )
    else:
        # –•–æ—Ä–æ—à–∏–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        report += "‚úÖ –•–æ—Ä–æ—à–∏–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!"
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á—ë—Ç –º–∞—Å—Ç–µ—Ä—É
    await message.answer(
        report, 
        reply_markup=cancel_menu_keyboard()
    )
    await state.clear()